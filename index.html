<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–î–´–†–û–ö–û–õ v2.1</title>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TRP1QX4878"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-TRP1QX4878');</script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&family=Noto+Sans+JP:wght@400;700&display=swap');

*{margin:0;padding:0;box-sizing:border-box;}

:root{
  --bg:#eeeef2;--panel-bg:#fff;--panel-border:#ccccd4;
  --grid-bg:#f0f0f4;--text:#1a1a2e;--text-sec:#666677;
  --accent:#c41830;--good:#1a8a4a;--warn:#b87000;
}

body{
  background:var(--bg);color:var(--text);
  font-family:'Share Tech Mono','Noto Sans JP',monospace;
  display:flex;justify-content:center;align-items:center;
  min-height:100vh;overflow:hidden;
}

#game-wrapper{display:flex;gap:20px;align-items:flex-start;}

#left-panel{display:flex;flex-direction:column;gap:12px;width:150px;}
#right-panel{display:flex;flex-direction:column;gap:12px;width:180px;}

.panel-box{background:var(--panel-bg);border:2px solid var(--panel-border);border-radius:8px;padding:10px 12px;}
.panel-label{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-sec);margin-bottom:4px;}

.stat-row{display:flex;justify-content:space-between;align-items:baseline;padding:6px 0;}
.stat-row+.stat-row{border-top:1px solid #ebebf0;}
.stat-label{font-size:12px;font-weight:700;color:var(--text-sec);letter-spacing:.5px;}
.stat-value{font-family:'Orbitron',sans-serif;font-weight:700;font-size:20px;text-align:right;min-width:60px;}
.stat-value.score-val{color:var(--good);}
.stat-value.penalty-val{color:var(--accent);}
.stat-value.pieces-val{color:var(--warn);}
.stat-value.total-val{color:var(--text);}

h1{font-family:'Orbitron',sans-serif;font-weight:900;font-size:24px;letter-spacing:3px;text-align:center;color:var(--accent);line-height:1.2;}
.subtitle{font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--text-sec);text-align:center;margin-top:3px;}

#next-piece-canvas{display:block;margin:0 auto;background:var(--grid-bg);border:1px solid var(--panel-border);border-radius:6px;}

.lang-selector{display:flex;gap:2px;flex-wrap:nowrap;}
.lang-btn{
  padding:3px 1px;border:2px solid var(--panel-border);border-radius:4px;
  background:var(--grid-bg);cursor:pointer;
  transition:all .15s;flex:1 1 0;min-width:0;
  display:flex;align-items:center;justify-content:center;
}
.lang-btn svg{display:block;border-radius:2px;width:22px;height:14px;}
.lang-btn:hover{border-color:#999;}
.lang-btn.active{border-color:#336;background:rgba(51,51,102,0.12);box-shadow:0 0 0 1px #336;}

.width-selector{display:flex;gap:4px;}
.width-btn{
  font-family:'Orbitron',sans-serif;font-weight:700;font-size:13px;
  flex:1;padding:5px 0;border:2px solid var(--panel-border);border-radius:5px;
  background:var(--grid-bg);color:var(--text-sec);cursor:pointer;text-align:center;transition:all .15s;
}
.width-btn:hover{border-color:#999;color:var(--text);}
.width-btn.active{border-color:var(--accent);color:#fff;background:var(--accent);}

.level-val{font-family:'Orbitron',sans-serif;font-weight:700;font-size:16px;color:var(--warn);}

#game-canvas{border:3px solid #bbb;border-radius:4px;box-shadow:0 2px 12px rgba(0,0,0,.1);display:block;}

/* ===== START SCREEN ===== */
#start-screen{
  display:flex;position:absolute;top:0;left:0;width:100%;height:100%;
  background:rgba(255,255,255,.96);z-index:250;
  flex-direction:column;justify-content:center;align-items:center;
  border-radius:4px;text-align:center;padding:20px;
}
#start-screen.hidden{display:none;}
.start-title{font-family:'Orbitron',sans-serif;font-weight:900;font-size:28px;color:var(--accent);letter-spacing:3px;margin-bottom:8px;}
.start-subtitle{font-size:11px;color:var(--text-sec);letter-spacing:2px;margin-bottom:24px;text-transform:uppercase;}

.start-section{margin-bottom:20px;}
.start-label{font-size:11px;font-weight:700;color:var(--text-sec);letter-spacing:1px;margin-bottom:8px;text-transform:uppercase;}

.nick-box{display:flex;gap:6px;align-items:center;justify-content:center;flex-wrap:wrap;}
.nick-display-start{
  font-family:'Orbitron',sans-serif;font-size:16px;font-weight:700;
  padding:8px 16px;border:2px solid var(--panel-border);border-radius:6px;
  background:#fff;color:var(--text);min-width:160px;text-align:center;
}
.nick-reroll-btn{
  font-size:18px;padding:6px 12px;border:2px solid var(--panel-border);border-radius:6px;
  background:var(--grid-bg);cursor:pointer;transition:all .15s;
}
.nick-reroll-btn:hover{border-color:#999;background:#e8e8ec;}

.nick-input-row{display:flex;gap:6px;align-items:center;justify-content:center;margin-top:10px;}
.nick-input{
  font-family:'Share Tech Mono',monospace;font-size:13px;
  padding:6px 10px;border:2px solid var(--panel-border);border-radius:5px;
  background:#fff;color:var(--text);width:180px;text-align:center;outline:none;
}
.nick-input:focus{border-color:#336;}
.nick-input::placeholder{color:#bbb;}
.nick-check-btn{
  font-family:'Orbitron',sans-serif;font-weight:700;font-size:10px;
  padding:7px 10px;border:2px solid var(--warn);border-radius:5px;
  background:var(--warn);color:#fff;cursor:pointer;letter-spacing:1px;transition:all .15s;
}
.nick-check-btn:hover{background:#a06800;}
.nick-status{font-size:10px;color:var(--accent);margin-top:6px;min-height:14px;}

.width-selector-start{display:flex;gap:6px;justify-content:center;}
.width-btn-start{
  font-family:'Orbitron',sans-serif;font-weight:700;font-size:16px;
  width:50px;height:50px;border:2px solid var(--panel-border);border-radius:8px;
  background:var(--grid-bg);color:var(--text-sec);cursor:pointer;transition:all .15s;
  display:flex;align-items:center;justify-content:center;
}
.width-btn-start:hover{border-color:#999;color:var(--text);}
.width-btn-start.active{border-color:var(--accent);color:#fff;background:var(--accent);}

#start-btn{
  font-family:'Orbitron',sans-serif;font-weight:700;font-size:16px;
  padding:14px 48px;border:2px solid #1e5eaa;border-radius:8px;
  background:#1e5eaa;color:#fff;cursor:pointer;letter-spacing:3px;transition:all .15s;
  margin-top:10px;
}
#start-btn:hover{background:#164a88;}

/* ===== GAME OVER ===== */
#game-over{
  display:none;position:absolute;top:0;left:0;width:100%;height:100%;
  background:rgba(255,255,255,.94);z-index:200;
  flex-direction:column;justify-content:center;align-items:center;
  border-radius:4px;text-align:center;padding:20px;
}
#game-over.show{display:flex;}
.go-title{font-family:'Orbitron',sans-serif;font-weight:900;font-size:18px;color:var(--accent);letter-spacing:2px;margin-bottom:16px;}
.go-score{font-family:'Orbitron',sans-serif;font-size:44px;font-weight:900;color:var(--text);margin-bottom:6px;line-height:1;}
.go-label{font-size:11px;color:var(--text-sec);letter-spacing:1px;margin-bottom:16px;}
.go-details{font-size:12px;color:var(--text);line-height:1.8;margin-bottom:16px;}
.go-details span{display:inline-block;margin:0 8px;}
.go-nick{font-family:'Orbitron',sans-serif;font-size:14px;font-weight:700;color:var(--text);margin-bottom:8px;}
.go-record{font-size:12px;color:var(--good);margin-bottom:16px;min-height:18px;}
.go-record.new-record{color:var(--accent);font-weight:700;}

#restart-btn{
  font-family:'Orbitron',sans-serif;font-weight:700;font-size:12px;
  padding:10px 28px;border:2px solid var(--accent);border-radius:6px;
  background:var(--accent);color:#fff;cursor:pointer;letter-spacing:2px;transition:all .15s;
}
#restart-btn:hover{background:#a01428;}

/* Pause */
#pause-overlay{
  display:none;position:absolute;top:0;left:0;width:100%;height:100%;
  background:rgba(255,255,255,.85);z-index:150;
  justify-content:center;align-items:center;border-radius:4px;
}
#pause-overlay.show{display:flex;}
#pause-overlay span{font-family:'Orbitron',sans-serif;font-weight:700;font-size:22px;color:var(--text);letter-spacing:4px;}

/* Popups */
.row-popup{position:absolute;font-family:'Orbitron',sans-serif;font-weight:700;font-size:15px;pointer-events:none;animation:popUp 1.2s ease-out forwards;z-index:100;white-space:nowrap;}
.row-popup.good{color:var(--good);}.row-popup.penalty{color:var(--accent);}
@keyframes popUp{0%{opacity:1;transform:translateY(0) scale(1);}70%{opacity:1;transform:translateY(-30px) scale(1.2);}100%{opacity:0;transform:translateY(-50px) scale(.8);}}
.row-flash{position:absolute;pointer-events:none;z-index:50;}
.row-flash.good-flash{background:rgba(26,138,74,.2);animation:flashFade .6s ease-out forwards;}
.row-flash.penalty-flash{background:rgba(196,24,48,.25);animation:flashFade .8s ease-out forwards;}
@keyframes flashFade{0%{opacity:1;}100%{opacity:0;}}

.uncloned-logo{
  position:fixed;bottom:8px;right:8px;
  font-family:'Orbitron',sans-serif;font-size:11px;font-weight:700;
  color:#c41830;text-decoration:none;opacity:0.8;
  transition:opacity .2s;z-index:999;
  background:rgba(255,255,255,0.9);padding:4px 8px;border-radius:4px;
}
.uncloned-logo:hover{opacity:1;}

.controls{font-size:11px;color:var(--text-sec);line-height:1.8;}
.controls kbd{display:inline-block;padding:1px 5px;border:2px solid #ccc;border-radius:3px;font-size:10px;font-weight:700;color:var(--text);background:#fff;min-width:20px;text-align:center;}

.legend{font-size:11px;color:var(--text);line-height:1.9;}
.legend .g1{color:var(--good);font-weight:700;}
.legend .g2{color:#2e8b57;font-weight:700;}
.legend .g3{color:#5a9a3a;font-weight:700;}
.legend .p{color:var(--accent);font-weight:700;}

/* ===== LEADERBOARD ===== */
.lb-title{font-family:'Orbitron',sans-serif;font-weight:700;font-size:11px;color:var(--text);letter-spacing:1px;margin-bottom:6px;}
.lb-period{font-size:9px;color:var(--text-sec);margin-bottom:8px;}
.lb-width-info{font-size:9px;color:var(--warn);margin-bottom:6px;font-weight:700;}
.lb-list{display:flex;flex-direction:column;gap:8px;}
.lb-entry{display:grid;grid-template-columns:22px 1fr;gap:2px 6px;padding:4px 0;border-bottom:1px solid #ebebf0;}
.lb-entry:last-child{border-bottom:none;}
.lb-rank{font-size:13px;grid-row:span 2;align-self:center;}
.lb-nick{font-weight:700;color:var(--text);font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.lb-score{font-family:'Orbitron',sans-serif;font-weight:700;font-size:14px;color:var(--good);}
.lb-first .lb-score{color:var(--accent);font-size:16px;}
.lb-first .lb-nick{color:var(--accent);}
.lb-empty{font-size:11px;color:var(--text-sec);font-style:italic;}
.lb-offline{font-size:10px;color:var(--accent);margin-top:4px;}

/* Mobile */
#mobile-controls{display:none;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:12px;}
.touch-btn{font-family:'Orbitron',sans-serif;font-weight:700;font-size:18px;width:54px;height:54px;border:2px solid #ccc;border-radius:10px;background:#fff;color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center;user-select:none;touch-action:manipulation;}
.touch-btn:active{background:#eee;border-color:#999;}
.touch-btn.drop-btn{width:80px;font-size:11px;letter-spacing:1px;}

@media(max-width:600px){
  #game-wrapper{flex-direction:column;align-items:center;gap:12px;}
  #left-panel,#right-panel{flex-direction:row;width:auto;gap:8px;flex-wrap:wrap;justify-content:center;}
  .panel-box{width:auto;min-width:100px;}
  #mobile-controls{display:flex;}
  .controls{display:none;}
}
</style>
</head>
<body>
<div id="game-wrapper">
  <div id="left-panel">
    <div style="text-align:center">
      <h1 id="title-1">–î–´–†–û</h1>
      <h1 id="title-2">–ö–û–õ</h1>
      <div class="subtitle" id="t-subtitle">—Å–æ–∑–¥–∞–≤–∞–π —Ö–∞–æ—Å</div>
      <div style="font-size:9px;color:var(--text-sec);opacity:0.5;text-align:center;margin-top:2px;">v2.0</div>
    </div>
    <div class="panel-box">
      <div class="panel-label" id="t-next">–°–ª–µ–¥—É—é—â–∞—è</div>
      <canvas id="next-piece-canvas" width="100" height="70"></canvas>
    </div>
    <div class="panel-box">
      <div class="panel-label" id="t-lang">–Ø–∑—ã–∫</div>
      <div class="lang-selector">
        <button class="lang-btn" data-lang="en" title="English"><svg width="24" height="16" viewBox="0 0 24 16"><rect width="24" height="16" fill="#012169"/><path d="M0,0 L24,16 M24,0 L0,16" stroke="#fff" stroke-width="2.4"/><path d="M0,0 L24,16 M24,0 L0,16" stroke="#C8102E" stroke-width="1.2"/><path d="M12,0 V16 M0,8 H24" stroke="#fff" stroke-width="4"/><path d="M12,0 V16 M0,8 H24" stroke="#C8102E" stroke-width="2.4"/></svg></button>
        <button class="lang-btn active" data-lang="ru" title="–†—É—Å—Å–∫–∏–π"><svg width="24" height="16" viewBox="0 0 24 16"><rect width="24" height="5.33" fill="#fff"/><rect y="5.33" width="24" height="5.34" fill="#0039A6"/><rect y="10.67" width="24" height="5.33" fill="#D52B1E"/></svg></button>
        <button class="lang-btn" data-lang="ja" title="Êó•Êú¨Ë™û"><svg width="24" height="16" viewBox="0 0 24 16"><rect width="24" height="16" fill="#fff"/><circle cx="12" cy="8" r="4.8" fill="#BC002D"/></svg></button>
        <button class="lang-btn" data-lang="de" title="Deutsch"><svg width="24" height="16" viewBox="0 0 24 16"><rect width="24" height="5.33" fill="#000"/><rect y="5.33" width="24" height="5.34" fill="#DD0000"/><rect y="10.67" width="24" height="5.33" fill="#FFCC00"/></svg></button>
        <button class="lang-btn" data-lang="fr" title="Fran√ßais"><svg width="24" height="16" viewBox="0 0 24 16"><rect width="8" height="16" fill="#002395"/><rect x="8" width="8" height="16" fill="#fff"/><rect x="16" width="8" height="16" fill="#ED2939"/></svg></button>
      </div>
    </div>
    <div class="panel-box">
      <div class="panel-label" id="t-level">–£—Ä–æ–≤–µ–Ω—å</div>
      <div class="level-val" id="level-display">1</div>
    </div>
    <div class="panel-box controls" id="controls-box">
      <kbd>‚Üê</kbd> <kbd>‚Üí</kbd> <span id="t-move">–¥–≤–∏–≥–∞—Ç—å</span><br>
      <kbd>‚Üë</kbd> <span id="t-rotate">–≤—Ä–∞—â–∞—Ç—å</span><br>
      <kbd>‚Üì</kbd> <span id="t-accel">—É—Å–∫–æ—Ä–∏—Ç—å</span><br>
      <kbd>‚éµ</kbd> <span id="t-drop">–±—Ä–æ—Å–∏—Ç—å</span><br>
      <kbd>P</kbd> <span id="t-pause-hint">–ø–∞—É–∑–∞</span>
    </div>
  </div>

  <div style="position:relative;">
    <canvas id="game-canvas"></canvas>
    
    <!-- START SCREEN -->
    <div id="start-screen">
      <div class="start-title" id="t-start-title">–î–´–†–û–ö–û–õ</div>
      <div class="start-subtitle" id="t-start-sub">—Å–æ–∑–¥–∞–≤–∞–π —Ö–∞–æ—Å</div>
      <div style="font-size:9px;color:var(--text-sec);opacity:0.5;text-align:center;">v2.0</div>
      
      <div class="start-section">
        <div class="start-label" id="t-your-nick">–¢–≤–æ–π –Ω–∏–∫</div>
        <div class="nick-box">
          <div class="nick-display-start" id="nick-display-start">???</div>
          <button class="nick-reroll-btn" id="nick-reroll-start" title="üé≤">üé≤</button>
        </div>
        <div class="nick-input-row">
          <input type="text" class="nick-input" id="nick-input" placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏ —Å–≤–æ–π...">
          <button class="nick-check-btn" id="nick-check-btn">‚úì</button>
        </div>
        <div class="nick-status" id="nick-status"></div>
      </div>
      
      <div class="start-section">
        <div class="start-label" id="t-choose-width">–®–∏—Ä–∏–Ω–∞ –ø–æ–ª—è</div>
        <div class="width-selector-start">
          <button class="width-btn-start" data-w="6">6</button>
          <button class="width-btn-start active" data-w="7">7</button>
          <button class="width-btn-start" data-w="8">8</button>
        </div>
      </div>
      
      <button id="start-btn">–ò–ì–†–ê–¢–¨</button>
    </div>
    
    <!-- GAME OVER -->
    <div id="game-over">
      <div class="go-title" id="t-gameover">–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê</div>
      <div class="go-nick" id="go-nick">???</div>
      <div class="go-score" id="go-total">0</div>
      <div class="go-label" id="t-total-label">–ò–¢–û–ì–û</div>
      <div class="go-details">
        <span style="color:var(--good)"><span id="t-go-score">–û—á–∫–∏</span>: <b id="go-score">0</b></span>
        <span style="color:var(--accent)"><span id="t-go-penalty">–®—Ç—Ä–∞—Ñ—ã</span>: <b id="go-penalty">0</b></span>
        <span style="color:var(--warn)"><span id="t-go-pieces">–§–∏–≥—É—Ä</span>: <b id="go-pieces">0</b></span>
      </div>
      <div class="go-record" id="go-record"></div>
      <button id="restart-btn">–ó–ê–ù–û–í–û</button>
      <button onclick="shareResultDyrokol()" style="margin-top:6px;padding:8px 20px;border-radius:8px;border:none;cursor:pointer;background:rgba(255,255,255,0.12);color:#aaa;font-size:13px;font-family:inherit;">üì§ Share</button>
      <div style="margin-top:14px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1);font-size:11px;">
        <div style="color:rgba(255,255,255,0.4);text-transform:uppercase;margin-bottom:6px;">More games</div>
        <div style="display:flex;flex-wrap:wrap;gap:5px;justify-content:center;">
          <a href="https://constrik.itch.io/rooms" target="_blank" style="color:#aaa;text-decoration:none;padding:3px 8px;background:rgba(255,255,255,0.08);border-radius:4px;">üè† Rooms</a>
          <a href="https://constrik.itch.io/open-office" target="_blank" style="color:#aaa;text-decoration:none;padding:3px 8px;background:rgba(255,255,255,0.08);border-radius:4px;">üè¢ Open Office</a>
          <a href="https://constrik.itch.io/neighbors" target="_blank" style="color:#aaa;text-decoration:none;padding:3px 8px;background:rgba(255,255,255,0.08);border-radius:4px;">üèò Neighbors</a>
          <a href="https://constrik.itch.io/ball-rush-league" target="_blank" style="color:#aaa;text-decoration:none;padding:3px 8px;background:rgba(255,255,255,0.08);border-radius:4px;">‚öΩ Ball Rush</a>
          <a href="https://constrik.itch.io" target="_blank" style="color:#aaa;text-decoration:none;padding:3px 8px;background:rgba(255,255,255,0.08);border-radius:4px;">üéÆ All Games</a>
        </div>
      </div>
    </div>
    
    <div id="pause-overlay"><span id="t-paused">–ü–ê–£–ó–ê</span></div>
  </div>

  <div id="right-panel">
    <div class="panel-box">
      <div class="stat-row">
        <span class="stat-label" id="t-score">–û—á–∫–∏</span>
        <span class="stat-value score-val" id="score-display">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label" id="t-penalty">–®—Ç—Ä–∞—Ñ—ã</span>
        <span class="stat-value penalty-val" id="penalty-display">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label" id="t-pieces">–§–∏–≥—É—Ä</span>
        <span class="stat-value pieces-val" id="pieces-display">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label" id="t-total">–ò—Ç–æ–≥–æ</span>
        <span class="stat-value total-val" id="total-display">0</span>
      </div>
    </div>

    <!-- LEADERBOARD -->
    <div class="panel-box" id="lb-box">
      <div class="lb-title" id="t-lb-title">üèÜ –¢–û–ü –ù–ï–î–ï–õ–ò</div>
      <div class="lb-period" id="lb-period"></div>
      <div class="lb-width-info" id="lb-width-info">–®–∏—Ä–∏–Ω–∞: 7</div>
      <div id="lb-content"><div class="lb-empty" id="t-lb-empty">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
    </div>

    <div class="panel-box legend" id="legend-box">
      <div class="panel-label" id="t-scoring">–°–∫–æ—Ä–∏–Ω–≥</div>
      <span class="g1" id="t-s1">1 –¥—ã—Ä–∫–∞ ‚Üí √ó5</span><br>
      <span class="g2" id="t-s2">2 –¥—ã—Ä–∫–∏ ‚Üí √ó3</span><br>
      <span class="g3" id="t-s3">3 –¥—ã—Ä–∫–∏ ‚Üí √ó2</span><br>
      <span style="color:var(--text-sec)" id="t-s4">4+ ‚Üí √ó1</span><br>
      <span class="p" id="t-s5">0 –¥—ã—Ä–æ–∫ ‚Üí ‚àí50 üí•</span>
    </div>
  </div>
</div>

<div id="mobile-controls">
  <button class="touch-btn" id="btn-left">‚Üê</button>
  <button class="touch-btn" id="btn-rotate">‚Üª</button>
  <button class="touch-btn" id="btn-right">‚Üí</button>
  <button class="touch-btn" id="btn-down">‚Üì</button>
  <button class="touch-btn drop-btn" id="btn-drop">DROP</button>
</div>

<a href="https://uncloned-math.netlify.app" target="_blank" class="uncloned-logo">Uncloned Math ‚Ä¢ v1.6</a>

<!-- ===== FIREBASE SDK ===== -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë  FIREBASE CONFIG                                      ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCqQSfmsv0ruNWFoHEG93bTBpJxMbww8nM",
  authDomain: "holepuncher-constr.firebaseapp.com",
  databaseURL: "https://holepuncher-constr-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "holepuncher-constr",
  storageBucket: "holepuncher-constr.firebasestorage.app",
  messagingSenderId: "356698016255",
  appId: "1:356698016255:web:913ed696aa4b3d17baffca"
};

// ===== FIREBASE INIT =====
let db = null;
let firebaseOk = false;

function initFirebase() {
  try {
    if (typeof firebase !== 'undefined' && FIREBASE_CONFIG.apiKey !== "YOUR_API_KEY") {
      firebase.initializeApp(FIREBASE_CONFIG);
      db = firebase.database();
      firebaseOk = true;
      console.log('Firebase connected');
    } else {
      console.log('Firebase not available or not configured');
    }
  } catch(e) {
    console.warn('Firebase init failed:', e);
  }
}

initFirebase();

// ===== WEEK KEY =====
function getLast7DaysLabel() {
  const now = new Date();
  const ago = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
  const fmt = d => d.getDate() + '.' + (d.getMonth()+1);
  return fmt(ago) + ' ‚Äì ' + fmt(now);
}

// ===== SUBMIT SCORE (only if beats record) =====
async function submitScore(nick, totalScore, w) {
  if (!firebaseOk || !db) return { success: false, isNewRecord: false };
  
  try {
    // Check existing best in last 7 days for this nick+width
    const sevenDaysAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
    const snap = await db.ref('leaderboard/scores/w' + w).orderByChild('ts').startAt(sevenDaysAgo).once('value');
    let existingBest = 0;
    snap.forEach(child => {
      const e = child.val();
      if (e.nick === nick && e.score > existingBest) existingBest = e.score;
    });
    
    if (existingBest >= totalScore) {
      return { success: true, isNewRecord: false, oldScore: existingBest };
    }
    
    // New record! Push it
    await db.ref('leaderboard/scores/w' + w).push().set({
      nick: nick,
      score: totalScore,
      ts: Date.now()
    });
    
    return { success: true, isNewRecord: true, oldScore: existingBest };
  } catch(e) {
    console.warn('Submit failed:', e);
    return { success: false, isNewRecord: false };
  }
}

// ===== LOAD LEADERBOARD (per width, sliding 7 days) =====
async function loadLeaderboard(w) {
  document.getElementById('lb-period').textContent = getLast7DaysLabel();
  
  const L = LANG[currentLang];
  document.getElementById('lb-width-info').textContent = (L.lbWidth || '–®–∏—Ä–∏–Ω–∞') + ': ' + w;

  if (!firebaseOk || !db) {
    showLeaderboardLocal(w);
    return;
  }

  try {
    const sevenDaysAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
    const snap = await db.ref('leaderboard/scores/w' + w).orderByChild('ts').startAt(sevenDaysAgo).once('value');
    // Group by nick, keep best score
    const best = {};
    snap.forEach(child => {
      const e = child.val();
      if (!e.nick) return;
      if (!best[e.nick] || e.score > best[e.nick].score) {
        best[e.nick] = e;
      }
    });
    const entries = Object.values(best);
    entries.sort((a, b) => b.score - a.score);
    renderLeaderboard(entries.slice(0, 10));
  } catch(e) {
    console.warn('Load LB failed:', e);
    showLeaderboardLocal(w);
  }
}

function renderLeaderboard(entries) {
  const container = document.getElementById('lb-content');
  const L = LANG[currentLang];
  if (entries.length === 0) {
    container.innerHTML = '<div class="lb-empty">' + (L.lbEmpty || '–ü–æ–∫–∞ –ø—É—Å—Ç–æ') + '</div>';
    return;
  }
  let html = '<div class="lb-list">';
  entries.forEach((e, i) => {
    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i+1);
    html += '<div class="lb-entry' + (i === 0 ? ' lb-first' : '') + '">';
    html += '<span class="lb-rank">' + medal + '</span>';
    html += '<span class="lb-nick">' + escHtml(e.nick) + '</span>';
    html += '<span class="lb-score">' + e.score + '</span>';
    html += '</div>';
  });
  html += '</div>';
  container.innerHTML = html;
}

function showLeaderboardLocal(w) {
  const container = document.getElementById('lb-content');
  const local = JSON.parse(localStorage.getItem('dyrokol_scores_w' + w) || '[]');
  const L = LANG[currentLang];
  if (local.length === 0) {
    container.innerHTML = '<div class="lb-empty">' + (L.lbEmpty || '–ü–æ–∫–∞ –ø—É—Å—Ç–æ') + '</div>';
    if (!firebaseOk) {
      container.innerHTML += '<div class="lb-offline">' + (L.lbOffline || 'Firebase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω') + '</div>';
    }
    return;
  }
  local.sort((a, b) => b.score - a.score);
  renderLeaderboard(local.slice(0, 10));
  if (!firebaseOk) {
    container.innerHTML += '<div class="lb-offline">' + (L.lbLocal || '–õ–æ–∫–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã') + '</div>';
  }
}

function saveLocalScore(nick, totalScore, w) {
  const key = 'dyrokol_scores_w' + w;
  const local = JSON.parse(localStorage.getItem(key) || '[]');
  
  // Find existing entry for this nick
  const idx = local.findIndex(e => e.nick === nick);
  if (idx >= 0) {
    if (local[idx].score >= totalScore) {
      return { isNewRecord: false, oldScore: local[idx].score };
    }
    local[idx].score = totalScore;
    local[idx].ts = Date.now();
  } else {
    local.push({ nick, score: totalScore, ts: Date.now() });
  }
  
  // Keep top 50
  local.sort((a, b) => b.score - a.score);
  if (local.length > 50) local.length = 50;
  localStorage.setItem(key, JSON.stringify(local));
  return { isNewRecord: true, oldScore: idx >= 0 ? local[idx].score : 0 };
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ===== LOCALIZATION =====
const LANG = {
  en: {
    title1:'HOLE', title2:'PUNCHER', subtitle:'create chaos',
    next:'Next', lang:'Language', width:'Width', level:'Level',
    move:'move', rotate:'rotate', accel:'faster', drop:'drop', pauseHint:'pause',
    gameover:'GAME OVER', totalLabel:'TOTAL', restart:'AGAIN',
    score:'Score', penalty:'Penalty', pieces:'Pieces', total:'Total',
    goScore:'Score', goPenalty:'Penalty', goPieces:'Pieces',
    scoring:'Scoring', 
    s1:'1 hole ‚Üí √ó5', s2:'2 holes ‚Üí √ó3', s3:'3 holes ‚Üí √ó2', s4:'4+ ‚Üí √ó1', s5:'0 holes ‚Üí ‚àí50 üí•',
    paused:'PAUSED', lbTitle:'üèÜ TOP OF THE WEEK', lbEmpty:'No scores yet', lbWidth:'Width',
    lbOffline:'Firebase not configured', lbLocal:'Local scores',
    startTitle:'HOLE PUNCHER', startSub:'create chaos', yourNick:'Your nickname',
    chooseWidth:'Field width', play:'PLAY', orEnter:'Or enter yours...',
    nickInvalid:'Invalid nickname', nickOk:'‚úì', newRecord:'üéâ NEW RECORD!', noRecord:'Your best stays'
  },
  ru: {
    title1:'–î–´–†–û', title2:'–ö–û–õ', subtitle:'—Å–æ–∑–¥–∞–≤–∞–π —Ö–∞–æ—Å',
    next:'–°–ª–µ–¥—É—é—â–∞—è', lang:'–Ø–∑—ã–∫', width:'–®–∏—Ä–∏–Ω–∞', level:'–£—Ä–æ–≤–µ–Ω—å',
    move:'–¥–≤–∏–≥–∞—Ç—å', rotate:'–≤—Ä–∞—â–∞—Ç—å', accel:'—É—Å–∫–æ—Ä–∏—Ç—å', drop:'–±—Ä–æ—Å–∏—Ç—å', pauseHint:'–ø–∞—É–∑–∞',
    gameover:'–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê', totalLabel:'–ò–¢–û–ì–û', restart:'–ó–ê–ù–û–í–û',
    score:'–û—á–∫–∏', penalty:'–®—Ç—Ä–∞—Ñ—ã', pieces:'–§–∏–≥—É—Ä', total:'–ò—Ç–æ–≥–æ',
    goScore:'–û—á–∫–∏', goPenalty:'–®—Ç—Ä–∞—Ñ—ã', goPieces:'–§–∏–≥—É—Ä',
    scoring:'–°–∫–æ—Ä–∏–Ω–≥',
    s1:'1 –¥—ã—Ä–∫–∞ ‚Üí √ó5', s2:'2 –¥—ã—Ä–∫–∏ ‚Üí √ó3', s3:'3 –¥—ã—Ä–∫–∏ ‚Üí √ó2', s4:'4+ ‚Üí √ó1', s5:'0 –¥—ã—Ä–æ–∫ ‚Üí ‚àí50 üí•',
    paused:'–ü–ê–£–ó–ê', lbTitle:'üèÜ –¢–û–ü –ù–ï–î–ï–õ–ò', lbEmpty:'–ü–æ–∫–∞ –ø—É—Å—Ç–æ', lbWidth:'–®–∏—Ä–∏–Ω–∞',
    lbOffline:'Firebase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω', lbLocal:'–õ–æ–∫–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã',
    startTitle:'–î–´–†–û–ö–û–õ', startSub:'—Å–æ–∑–¥–∞–≤–∞–π —Ö–∞–æ—Å', yourNick:'–¢–≤–æ–π –Ω–∏–∫',
    chooseWidth:'–®–∏—Ä–∏–Ω–∞ –ø–æ–ª—è', play:'–ò–ì–†–ê–¢–¨', orEnter:'–ò–ª–∏ –≤–≤–µ–¥–∏ —Å–≤–æ–π...',
    nickInvalid:'–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–∏–∫', nickOk:'‚úì', newRecord:'üéâ –ù–û–í–´–ô –†–ï–ö–û–†–î!', noRecord:'–¢–≤–æ–π –ª—É—á—à–∏–π –æ—Å—Ç–∞—ë—Ç—Å—è'
  },
  ja: {
    title1:'„Éë„É≥', title2:'„ÉÅ„É£„Éº', subtitle:'„Ç´„Ç™„Çπ„Çí‰Ωú„Çå',
    next:'Ê¨°', lang:'Ë®ÄË™û', width:'ÂπÖ', level:'„É¨„Éô„É´',
    move:'ÁßªÂãï', rotate:'ÂõûËª¢', accel:'Âä†ÈÄü', drop:'ËêΩ‰∏ã', pauseHint:'‰∏ÄÊôÇÂÅúÊ≠¢',
    gameover:'„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº', totalLabel:'ÂêàË®à', restart:'„É™„Çπ„Çø„Éº„Éà',
    score:'ÂæóÁÇπ', penalty:'„Éö„Éä„É´„ÉÜ„Ç£', pieces:'„Éî„Éº„Çπ', total:'ÂêàË®à',
    goScore:'ÂæóÁÇπ', goPenalty:'„Éö„Éä„É´„ÉÜ„Ç£', goPieces:'„Éî„Éº„Çπ',
    scoring:'„Çπ„Ç≥„Ç¢',
    s1:'1Á©¥ ‚Üí √ó5', s2:'2Á©¥ ‚Üí √ó3', s3:'3Á©¥ ‚Üí √ó2', s4:'4+ ‚Üí √ó1', s5:'0Á©¥ ‚Üí ‚àí50 üí•',
    paused:'‰∏ÄÊôÇÂÅúÊ≠¢', lbTitle:'üèÜ ‰ªäÈÄ±„ÅÆ„Éà„ÉÉ„Éó', lbEmpty:'„Åæ„Å†„Çπ„Ç≥„Ç¢„Å™„Åó', lbWidth:'ÂπÖ',
    lbOffline:'FirebaseÊú™Ë®≠ÂÆö', lbLocal:'„É≠„Éº„Ç´„É´„Çπ„Ç≥„Ç¢',
    startTitle:'„Éë„É≥„ÉÅ„É£„Éº', startSub:'„Ç´„Ç™„Çπ„Çí‰Ωú„Çå', yourNick:'„Éã„ÉÉ„ÇØ„Éç„Éº„É†',
    chooseWidth:'„Éï„Ç£„Éº„É´„ÉâÂπÖ', play:'„Éó„É¨„Ç§', orEnter:'„Åæ„Åü„ÅØÂÖ•Âäõ...',
    nickInvalid:'ÁÑ°Âäπ„Å™„Éã„ÉÉ„ÇØ', nickOk:'‚úì', newRecord:'üéâ Êñ∞Ë®òÈå≤!', noRecord:'„Éô„Çπ„ÉàÁ∂≠ÊåÅ'
  },
  de: {
    title1:'LO', title2:'CHER', subtitle:'schaffe Chaos',
    next:'N√§chstes', lang:'Sprache', width:'Breite', level:'Level',
    move:'bewegen', rotate:'drehen', accel:'schneller', drop:'fallen', pauseHint:'Pause',
    gameover:'SPIEL VORBEI', totalLabel:'GESAMT', restart:'NEUSTART',
    score:'Punkte', penalty:'Strafen', pieces:'Teile', total:'Gesamt',
    goScore:'Punkte', goPenalty:'Strafen', goPieces:'Teile',
    scoring:'Punkte',
    s1:'1 Loch ‚Üí √ó5', s2:'2 L√∂cher ‚Üí √ó3', s3:'3 L√∂cher ‚Üí √ó2', s4:'4+ ‚Üí √ó1', s5:'0 L√∂cher ‚Üí ‚àí50 üí•',
    paused:'PAUSE', lbTitle:'üèÜ TOP DER WOCHE', lbEmpty:'Noch keine Ergebnisse', lbWidth:'Breite',
    lbOffline:'Firebase nicht konfiguriert', lbLocal:'Lokale Ergebnisse',
    startTitle:'LOCHER', startSub:'schaffe Chaos', yourNick:'Dein Nickname',
    chooseWidth:'Feldbreite', play:'SPIELEN', orEnter:'Oder eingeben...',
    nickInvalid:'Ung√ºltiger Nick', nickOk:'‚úì', newRecord:'üéâ NEUER REKORD!', noRecord:'Dein Bestes bleibt'
  },
  fr: {
    title1:'PER', title2:'FO', subtitle:'cr√©e le chaos',
    next:'Suivant', lang:'Langue', width:'Largeur', level:'Niveau',
    move:'d√©placer', rotate:'tourner', accel:'acc√©l√©rer', drop:'l√¢cher', pauseHint:'pause',
    gameover:'PARTIE TERMIN√âE', totalLabel:'TOTAL', restart:'REJOUER',
    score:'Points', penalty:'P√©nalit√©', pieces:'Pi√®ces', total:'Total',
    goScore:'Points', goPenalty:'P√©nalit√©', goPieces:'Pi√®ces',
    scoring:'Points',
    s1:'1 trou ‚Üí √ó5', s2:'2 trous ‚Üí √ó3', s3:'3 trous ‚Üí √ó2', s4:'4+ ‚Üí √ó1', s5:'0 trous ‚Üí ‚àí50 üí•',
    paused:'PAUSE', lbTitle:'üèÜ TOP DE LA SEMAINE', lbEmpty:'Pas encore de scores', lbWidth:'Largeur',
    lbOffline:'Firebase non configur√©', lbLocal:'Scores locaux',
    startTitle:'PERFO', startSub:'cr√©e le chaos', yourNick:'Ton pseudo',
    chooseWidth:'Largeur du terrain', play:'JOUER', orEnter:'Ou entre le tien...',
    nickInvalid:'Pseudo invalide', nickOk:'‚úì', newRecord:'üéâ NOUVEAU RECORD!', noRecord:'Ton meilleur reste'
  }
};

let currentLang = 'ru';
let currentNick = '';

// ===== NICK GENERATOR =====
const NICK_WORDS = {
  en: {
    adj: ['Fast','Chaos','Dark','Bright','Silent','Wild','Crazy','Lucky','Swift','Bold','Epic','Tiny','Mega','Ultra','Cosmic','Neon','Pixel','Turbo','Hyper','Super','Mighty','Sneaky','Fluffy','Grumpy','Sleepy','Jumpy','Dizzy','Fancy','Spicy','Crispy','Frozen','Blazing','Thunder','Electric','Atomic','Quantum','Stellar','Galactic','Mystic','Ancient','Golden','Silver','Crystal','Shadow','Phantom','Ghost','Ninja','Cyber','Retro','Funky','Groovy','Hipster','Chill','Zen','Laser','Rocket','Stealth','Savage','Wicked','Twisted','Wonky','Derpy','Goofy','Clumsy','Bouncy','Wobbly','Squishy','Crunchy','Zappy','Fizzy','Bubbly','Sparkly','Glowing','Shiny','Matte','Velvet','Chrome','Rusty','Dusty','Foggy','Stormy','Sunny','Lunar','Solar','Astral','Primal','Royal','Noble','Rogue','Rebel','Viking','Pirate','Wizard','Dragon','Phoenix','Tiger','Panda','Koala','Sloth','Otter','Disco','Nitro'],
    noun: ['Puncher','Stacker','Holer','Master','Ninja','Hero','Wizard','Ghost','Storm','Flash','Hawk','Wolf','Tiger','Phoenix','Dragon','Knight','Pirate','Robot','Coder','Gamer','Panda','Koala','Sloth','Otter','Penguin','Llama','Alpaca','Corgi','Shiba','Doge','Potato','Waffle','Taco','Burrito','Noodle','Dumpling','Cookie','Muffin','Cupcake','Donut','Pretzel','Pickle','Nugget','Banana','Coconut','Mango','Kiwi','Avocado','Tofu','Sushi','Ramen','Boba','Cheese','Bacon','Toast','Pancake','Wombat','Platypus','Narwhal','Walrus','Dolphin','Octopus','Squid','Crab','Lobster','Shrimp','Jellyfish','Starfish','Turtle','Gecko','Iguana','Cobra','Viper','Falcon','Eagle','Owl','Raven','Crow','Sparrow','Parrot','Toucan','Pelican','Flamingo','Swan','Goose','Duck','Chicken','Rooster','Turkey','Moose','Elk','Deer','Bear','Badger','Beaver','Squirrel','Chipmunk','Hamster','Gerbil']
  },
  ru: {
    adj: ['–ë—ã—Å—Ç—Ä—ã–π','–•–∞–æ—Å','–¢—ë–º–Ω—ã–π','–Ø—Ä–∫–∏–π','–¢–∏—Ö–∏–π','–î–∏–∫–∏–π','–ë–µ–∑—É–º–Ω—ã–π','–í–µ–∑—É—á–∏–π','–õ–æ–≤–∫–∏–π','–°–º–µ–ª—ã–π','–≠–ø–∏–∫','–ú–∏–Ω–∏','–ú–µ–≥–∞','–£–ª—å—Ç—Ä–∞','–ö–æ—Å–º–æ','–ù–µ–æ–Ω','–ü–∏–∫—Å–µ–ª—å','–¢—É—Ä–±–æ','–ì–∏–ø–µ—Ä','–°—É–ø–µ—Ä','–ú–æ–≥—É—á–∏–π','–•–∏—Ç—Ä—ã–π','–ü—É—à–∏—Å—Ç—ã–π','–í–æ—Ä—á–ª–∏–≤—ã–π','–°–æ–Ω–Ω—ã–π','–ü—Ä—ã–≥—É—á–∏–π','–®–∞–ª—å–Ω–æ–π','–ú–æ–¥–Ω—ã–π','–û—Å—Ç—Ä—ã–π','–•—Ä—É—Å—Ç—è—â–∏–π','–õ–µ–¥—è–Ω–æ–π','–û–≥–Ω–µ–Ω–Ω—ã–π','–ì—Ä–æ–º–æ–≤–æ–π','–≠–ª–µ–∫—Ç—Ä–æ','–ê—Ç–æ–º–Ω—ã–π','–ö–≤–∞–Ω—Ç–æ–≤—ã–π','–ó–≤—ë–∑–¥–Ω—ã–π','–ì–∞–ª–∞–∫—Ç–∏–∫','–ú–∏—Å—Ç–∏–∫','–î—Ä–µ–≤–Ω–∏–π','–ó–æ–ª–æ—Ç–æ–π','–°–µ—Ä–µ–±—Ä—è–Ω—ã–π','–•—Ä—É—Å—Ç–∞–ª—å–Ω—ã–π','–¢–µ–Ω–µ–≤–æ–π','–§–∞–Ω—Ç–æ–º','–ü—Ä–∏–∑—Ä–∞—á–Ω—ã–π','–ù–∏–Ω–¥–∑—è','–ö–∏–±–µ—Ä','–†–µ—Ç—Ä–æ','–§–∞–Ω–∫–∏','–ì—Ä—É–≤–æ–≤—ã–π','–•–∏–ø—Å—Ç–µ—Ä','–ß–∏–ª–ª','–î–∑–µ–Ω','–õ–∞–∑–µ—Ä','–†–∞–∫–µ—Ç–Ω—ã–π','–°—Ç–µ–ª—Å','–î–µ—Ä–∑–∫–∏–π','–ö—Ä—É—Ç–æ–π','–ß—É–¥–Ω–æ–π','–®–µ–±—É—Ç–Ω–æ–π','–î—É—Ä–∞—à–∫–∞','–ì—É—Ñ–∏','–ù–µ—É–∫–ª—é–∂–∏–π','–ü—Ä—É–∂–∏–Ω–∫–∞','–®–∞—Ç–∫–∏–π','–ú—è–≥–∫–∏–π','–•—Ä—É–º–∫–∏–π','–ò—Å–∫—Ä–∞','–®–∏–ø—É—á–∏–π','–ü—É–∑—ã—Ä—å','–°–≤–µ—Ä–∫–∞—á','–°–≤–µ—Ç—è—â–∏–π','–ë–ª–µ—Å—Ç—è—â–∏–π','–ú–∞—Ç–æ–≤—ã–π','–ë–∞—Ä—Ö–∞—Ç','–•—Ä–æ–º','–†–∂–∞–≤—ã–π','–ü—ã–ª—å–Ω—ã–π','–¢—É–º–∞–Ω–Ω—ã–π','–®—Ç–æ—Ä–º–æ–≤–æ–π','–°–æ–ª–Ω–µ—á–Ω—ã–π','–õ—É–Ω–Ω—ã–π','–°–æ–ª–∞—Ä','–ê—Å—Ç—Ä–∞–ª','–î–∏–∫–∏–π','–ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π','–ë–ª–∞–≥–æ—Ä–æ–¥–Ω—ã–π','–ü–ª—É—Ç','–ë—É–Ω—Ç–∞—Ä—å','–í–∏–∫–∏–Ω–≥','–ü–∏—Ä–∞—Ç','–í–æ–ª—à–µ–±–Ω—ã–π','–î—Ä–∞–∫–æ–Ω–∏–π','–§–µ–Ω–∏–∫—Å–æ–≤—ã–π','–¢–∏–≥—Ä–æ–≤—ã–π','–ü–∞–Ω–¥–∞','–ö–æ–∞–ª–∞','–õ–µ–Ω–∏–≤—ã–π','–í—ã–¥—Ä–æ–≤—ã–π','–î–∏—Å–∫–æ','–ù–∏—Ç—Ä–æ'],
    noun: ['–î—ã—Ä–æ–∫–æ–ª','–°—Ç–∞–∫–µ—Ä','–ú–∞—Å—Ç–µ—Ä','–ù–∏–Ω–¥–∑—è','–ì–µ—Ä–æ–π','–ú–∞–≥','–ü—Ä–∏–∑—Ä–∞–∫','–®—Ç–æ—Ä–º','–ú–æ–ª–Ω–∏—è','–Ø—Å—Ç—Ä–µ–±','–í–æ–ª–∫','–¢–∏–≥—Ä','–§–µ–Ω–∏–∫—Å','–î—Ä–∞–∫–æ–Ω','–†—ã—Ü–∞—Ä—å','–ü–∏—Ä–∞—Ç','–†–æ–±–æ—Ç','–ö–æ–¥–µ—Ä','–ì–µ–π–º–µ—Ä','–•–∞–∫–µ—Ä','–ü–∞–Ω–¥–∞','–ö–æ–∞–ª–∞','–õ–µ–Ω–∏–≤–µ—Ü','–í—ã–¥—Ä–∞','–ü–∏–Ω–≥–≤–∏–Ω','–õ–∞–º–∞','–ê–ª—å–ø–∞–∫–∞','–ö–æ—Ä–≥–∏','–®–∏–±–∞','–î–æ–∂','–ö–∞—Ä—Ç–æ—Ö–∞','–í–∞—Ñ–ª—è','–¢–∞–∫–æ','–ë—É—Ä—Ä–∏—Ç–æ','–õ–∞–ø—à–∞','–ü–µ–ª—å–º–µ–Ω—å','–ü–µ—á–µ–Ω—å–∫–∞','–ú–∞—Ñ—Ñ–∏–Ω','–ö–µ–∫—Å–∏–∫','–ü–æ–Ω—á–∏–∫','–ö—Ä–µ–Ω–¥–µ–ª—å','–û–≥—É—Ä—á–∏–∫','–ù–∞–≥–≥–µ—Ç—Å','–ë–∞–Ω–∞–Ω','–ö–æ–∫–æ—Å','–ú–∞–Ω–≥–æ','–ö–∏–≤–∏','–ê–≤–æ–∫–∞–¥–æ','–¢–æ—Ñ—É','–°—É—à–∏','–†–∞–º–µ–Ω','–ë–æ–±–∞','–°—ã—Ä–æ–∫','–ë–µ–∫–æ–Ω','–¢–æ—Å—Ç–µ—Ä','–ë–ª–∏–Ω—á–∏–∫','–í–æ–º–±–∞—Ç','–£—Ç–∫–æ–Ω–æ—Å','–ù–∞—Ä–≤–∞–ª','–ú–æ—Ä–∂','–î–µ–ª—å—Ñ–∏–Ω','–û—Å—å–º–∏–Ω–æ–≥','–ö–∞–ª—å–º–∞—Ä','–ö—Ä–∞–±','–õ–æ–±—Å—Ç–µ—Ä','–ö—Ä–µ–≤–µ—Ç–∫–∞','–ú–µ–¥—É–∑–∞','–ó–≤–µ–∑–¥–∞','–ß–µ—Ä–µ–ø–∞—Ö–∞','–ì–µ–∫–∫–æ–Ω','–ò–≥—É–∞–Ω–∞','–ö–æ–±—Ä–∞','–ì–∞–¥—é–∫–∞','–°–æ–∫–æ–ª','–û—Ä—ë–ª','–°–æ–≤–∞','–í–æ—Ä–æ–Ω','–í–æ—Ä–æ–Ω–∞','–í–æ—Ä–æ–±–µ–π','–ü–æ–ø—É–≥–∞–π','–¢—É–∫–∞–Ω','–ü–µ–ª–∏–∫–∞–Ω','–§–ª–∞–º–∏–Ω–≥–æ','–õ–µ–±–µ–¥—å','–ì—É—Å—å','–£—Ç–∫–∞','–ö—É—Ä–∏—Ü–∞','–ü–µ—Ç—É—Ö','–ò–Ω–¥—é–∫','–õ–æ—Å—å','–û–ª–µ–Ω—å','–ú–µ–¥–≤–µ–¥—å','–ë–∞—Ä—Å—É–∫','–ë–æ–±—ë—Ä','–ë–µ–ª–∫–∞','–ë—É—Ä—É–Ω–¥—É–∫','–•–æ–º—è–∫','–ü–µ—Å–∏–∫','–ö–æ—Ç–∏–∫']
  },
  ja: {
    adj: ['ÈÄü„ÅÑ','Èóá„ÅÆ','ÂÖâ„ÅÆ','Èùô„Åã„Å™','ÈáéÁîü„ÅÆ','ÁãÇ„Å£„Åü','Âπ∏ÈÅã„ÅÆ','Á¥†Êó©„ÅÑ','ÂãáÊï¢„Å™','Ë∂Ö','Â∞è„Åï„Å™','Â∑®Â§ß„Å™','ÂÆáÂÆô„ÅÆ','„Éç„Ç™„É≥','„Éî„ÇØ„Çª„É´','„Çø„Éº„Éú','„Éè„Ç§„Éë„Éº','„Çπ„Éº„Éë„Éº','ÊúÄÂº∑„ÅÆ','‰ºùË™¨„ÅÆ','Âº∑Âäõ„Å™','Áã°Áåæ„Å™','„ÇÇ„Åµ„ÇÇ„Åµ','‰∏çÊ©üÂ´å„Å™','Áú†„ÅÑ','Ë∑≥„Å≠„Çã','ÁõÆÁú©„ÅÆ','Ê¥æÊâã„Å™','Ëæõ„ÅÑ','„Ç´„É™„Ç´„É™','Âáç„Å£„Åü','ÁáÉ„Åà„Çã','Èõ∑„ÅÆ','ÈõªÊ∞ó„ÅÆ','ÂéüÂ≠ê„ÅÆ','ÈáèÂ≠ê„ÅÆ','Êòü„ÅÆ','ÈäÄÊ≤≥„ÅÆ','Á•ûÁßò„ÅÆ','Âè§‰ª£„ÅÆ','ÈªÑÈáë„ÅÆ','ÈäÄ„ÅÆ','Ê∞¥Êô∂„ÅÆ','ÂΩ±„ÅÆ','Âπª„ÅÆ','ÂπΩÈúä„ÅÆ','ÂøçËÄÖ„ÅÆ','„Çµ„Ç§„Éê„Éº','„É¨„Éà„É≠','„Éï„Ç°„É≥„Ç≠„Éº','„Ç∞„É´„Éº„É¥„Ç£','„Éí„ÉÉ„Éó','„ÉÅ„É´','Á¶Ö„ÅÆ','„É¨„Éº„Ç∂„Éº','„É≠„Ç±„ÉÉ„Éà','„Çπ„ÉÜ„É´„Çπ','ÊøÄ„Åó„ÅÑ','ÈÇ™ÊÇ™„Å™','„Å≠„Åò„Çå„Åü','Â§â„Å™','„Åä„Åã„Åó„Å™','„Éâ„Ç∏„Å™','Âºæ„ÇÄ','„Åµ„Çâ„Åµ„Çâ','„Å∑„Å´„Å∑„Å´','„Çµ„ÇØ„Çµ„ÇØ','„Éì„É™„Éì„É™','„Ç∑„É•„ÉØ„Ç∑„É•„ÉØ','Ê≥°„ÅÆ','„Ç≠„É©„Ç≠„É©','ÂÖâ„Çã','Ëºù„Åè','„Éû„ÉÉ„Éà','„Éô„É´„Éô„ÉÉ„Éà','„ÇØ„É≠„Éº„É†','ÈåÜ„Å≥„Åü','ÂüÉ„ÅÆ','Èúß„ÅÆ','Âµê„ÅÆ','Êô¥„Çå„ÅÆ','Êúà„ÅÆ','Â§™ÈôΩ„ÅÆ','ÊòüÁïå„ÅÆ','ÂéüÂßã„ÅÆ','ÁéãÂÆ§„ÅÆ','È´òË≤¥„Å™','ÊÇ™ÂÖö„ÅÆ','ÂèçÈÄÜ„ÅÆ','Êµ∑Ë≥ä„ÅÆ','È≠îÊ≥ï„ÅÆ','Á´ú„ÅÆ','‰∏çÊ≠ªÈ≥•„ÅÆ','Ëôé„ÅÆ','„Éë„É≥„ÉÄ„ÅÆ','„Ç≥„Ç¢„É©„ÅÆ','„ÅÆ„Çì„Å≥„Çä','„Ç´„ÉØ„Ç¶„ÇΩ„ÅÆ','„Éá„Ç£„Çπ„Ç≥','„Éã„Éà„É≠'],
    noun: ['„Éë„É≥„ÉÅ„É£„Éº','„Éû„Çπ„Çø„Éº','ÂøçËÄÖ','Ëã±ÈõÑ','È≠îÊ≥ï‰Ωø„ÅÑ','ÂπΩÈúä','Âµê','Á®≤Â¶ª','È∑π','Áãº','Ëôé','‰∏çÊ≠ªÈ≥•','Èæç','È®éÂ£´','Êµ∑Ë≥ä','„É≠„Éú„ÉÉ„Éà','Êà¶Â£´','ÈÅî‰∫∫','ÁéãËÄÖ','Ë¶áËÄÖ','„Éë„É≥„ÉÄ','„Ç≥„Ç¢„É©','„Éä„Éû„Ç±„É¢„Éé','„Ç´„ÉØ„Ç¶„ÇΩ','„Éö„É≥„ÇÆ„É≥','„É©„Éû','„Ç¢„É´„Éë„Ç´','„Ç≥„Éº„ÇÆ„Éº','Êü¥Áä¨','„Çè„Çì„Åì','„Éù„ÉÜ„Éà','„ÉØ„ÉÉ„Éï„É´','„Çø„Ç≥„Çπ','„Éñ„É™„Éà„Éº','„Éå„Éº„Éâ„É´','È§ÉÂ≠ê','„ÇØ„ÉÉ„Ç≠„Éº','„Éû„Éï„Ç£„É≥','„Ç´„ÉÉ„Éó„Ç±„Éº„Ç≠','„Éâ„Éº„Éä„ÉÑ','„Éó„É¨„ÉÉ„ÉÑ„Çß„É´','„Éî„ÇØ„É´„Çπ','„Éä„Ç≤„ÉÉ„Éà','„Éê„Éä„Éä','„Ç≥„Ç≥„Éä„ÉÉ„ÉÑ','„Éû„É≥„Ç¥„Éº','„Ç≠„Ç¶„Ç§','„Ç¢„Éú„Ç´„Éâ','Ë±ÜËÖê','ÂØøÂè∏','„É©„Éº„É°„É≥','„Çø„Éî„Ç™„Ç´','„ÉÅ„Éº„Ç∫','„Éô„Éº„Ç≥„É≥','„Éà„Éº„Çπ„Éà','„Éë„É≥„Ç±„Éº„Ç≠','„Ç¶„Ç©„É≥„Éê„ÉÉ„Éà','„Ç´„É¢„Éé„Éè„Ç∑','„Ç§„ÉÉ„Ç´„ÇØ','„Çª„Ç§„Ç¶„ÉÅ','„Ç§„É´„Ç´','„Çø„Ç≥','„Ç§„Ç´','„Ç´„Éã','„É≠„Éñ„Çπ„Çø„Éº','„Ç®„Éì','„ÇØ„É©„Ç≤','„Éí„Éà„Éá','„Ç´„É°','„É§„É¢„É™','„Ç§„Ç∞„Ç¢„Éä','„Ç≥„Éñ„É©','„Éê„Ç§„Éë„Éº','„Éè„É§„Éñ„Çµ','„ÉØ„Ç∑','„Éï„ÇØ„É≠„Ç¶','„Ç´„É©„Çπ','„Çπ„Ç∫„É°','„Ç™„Ç¶„É†','„Éà„Ç´„É≥','„Éö„É™„Ç´„É≥','„Éï„É©„Éü„É≥„Ç¥','ÁôΩÈ≥•','„Ç¨„ÉÅ„Éß„Ç¶','„Ç¢„Éí„É´','„Éã„ÉØ„Éà„É™','ÈõÑÈ∂è','‰∏ÉÈù¢È≥•','„Éò„É©„Ç∏„Ç´','Èπø','ÁÜä','„Ç¢„Éä„Ç∞„Éû','„Éì„Éº„Éê„Éº','„É™„Çπ','„Ç∑„Éû„É™„Çπ','„Éè„É†„Çπ„Çø„Éº','„Å´„ÇÉ„Çì„Åì','„ÅÜ„Åï„Åé']
  },
  de: {
    adj: ['Schnell','Chaos','Dunkel','Hell','Still','Wild','Verr√ºckt','Gl√ºck','Flink','K√ºhn','Episch','Mini','Mega','Ultra','Kosmo','Neon','Pixel','Turbo','Hyper','Super','M√§chtig','Listig','Flauschig','M√ºrrisch','Schl√§frig','H√ºpfend','Schwindlig','Schick','W√ºrzig','Knusprig','Gefroren','Brennend','Donner','Elektro','Atomar','Quantum','Stellar','Galaktisch','Mystisch','Antik','Golden','Silber','Kristall','Schatten','Phantom','Geist','Ninja','Cyber','Retro','Funky','Groovy','Hipster','Chill','Zen','Laser','Rakete','Stealth','Savage','B√∂se','Verdreht','Wonky','Derpy','Albern','Tolpatschig','Federnd','Wackelig','Weich','Knackig','Zappelig','Sprudelnd','Blubbrig','Funkelnd','Leuchtend','Gl√§nzend','Matt','Samt','Chrom','Rostig','Staubig','Neblig','St√ºrmisch','Sonnig','Lunar','Solar','Astral','Urzeit','Royal','Edel','Schurke','Rebell','Wikinger','Pirat','Zauberer','Drachen','Phoenix','Tiger','Panda','Koala','Faultier','Otter','Disco','Nitro'],
    noun: ['Locher','Meister','Ninja','Held','Magier','Geist','Sturm','Blitz','Falke','Wolf','Tiger','Ph√∂nix','Drache','Ritter','Pirat','Roboter','Krieger','Gamer','K√∂nig','Legende','Panda','Koala','Faultier','Otter','Pinguin','Lama','Alpaka','Corgi','Shiba','Doge','Kartoffel','Waffel','Taco','Burrito','Nudel','Kn√∂del','Keks','Muffin','Cupcake','Donut','Brezel','Gurke','Nugget','Banane','Kokos','Mango','Kiwi','Avocado','Tofu','Sushi','Ramen','Boba','K√§se','Speck','Toast','Pfannkuchen','Wombat','Schnabeltier','Narwal','Walross','Delfin','Oktopus','Tintenfisch','Krabbe','Hummer','Garnele','Qualle','Seestern','Schildkr√∂te','Gecko','Leguan','Kobra','Viper','Falke','Adler','Eule','Rabe','Kr√§he','Spatz','Papagei','Tukan','Pelikan','Flamingo','Schwan','Gans','Ente','Huhn','Hahn','Truthahn','Elch','Hirsch','B√§r','Dachs','Biber','Eichh√∂rnchen','Hamster','Maus','Hase','Katze']
  },
  fr: {
    adj: ['Rapide','Chaos','Sombre','Brillant','Silencieux','Sauvage','Fou','Chanceux','Agile','Brave','√âpique','Mini','M√©ga','Ultra','Cosmo','N√©on','Pixel','Turbo','Hyper','Super','Puissant','Rus√©','Pelucheux','Grognon','Somnolent','Bondissant','√âtourdi','Chic','√âpic√©','Croustillant','Gel√©','Flamboyant','Tonnerre','√âlectro','Atomique','Quantum','Stellaire','Galactique','Mystique','Ancien','Dor√©','Argent√©','Cristal','Ombre','Fant√¥me','Spectre','Ninja','Cyber','R√©tro','Funky','Groovy','Hipster','Chill','Zen','Laser','Fus√©e','Furtif','F√©roce','M√©chant','Tordu','Farfelu','Derpy','Maladroit','Gauche','Rebondissant','Bancal','Moelleux','Croquant','Zapp√©','P√©tillant','Bulleux','√âtincelant','Lumineux','Scintillant','Mat','Velours','Chrome','Rouill√©','Poussi√©reux','Brumeux','Orageux','Ensoleill√©','Lunaire','Solaire','Astral','Primitif','Royal','Noble','Voyou','Rebelle','Viking','Pirate','Sorcier','Dragon','Ph√©nix','Tigre','Panda','Koala','Paresseux','Loutre','Disco','Nitro'],
    noun: ['Perfo','Ma√Ætre','Ninja','H√©ros','Mage','Fant√¥me','Temp√™te','√âclair','Faucon','Loup','Tigre','Ph√©nix','Dragon','Chevalier','Pirate','Robot','Guerrier','Gamer','Roi','L√©gende','Panda','Koala','Paresseux','Loutre','Pingouin','Lama','Alpaga','Corgi','Shiba','Doge','Patate','Gaufre','Taco','Burrito','Nouille','Ravioli','Cookie','Muffin','Cupcake','Donut','Bretzel','Cornichon','Nugget','Banane','Noix','Mangue','Kiwi','Avocat','Tofu','Sushi','Ramen','Boba','Fromage','Bacon','Toast','Cr√™pe','Wombat','Ornithorynque','Narval','Morse','Dauphin','Poulpe','Calamar','Crabe','Homard','Crevette','M√©duse','√âtoile','Tortue','Gecko','Iguane','Cobra','Vip√®re','Faucon','Aigle','Hibou','Corbeau','Corneille','Moineau','Perroquet','Toucan','P√©lican','Flamant','Cygne','Oie','Canard','Poulet','Coq','Dinde','√âlan','Cerf','Ours','Blaireau','Castor','√âcureuil','Hamster','Souris','Lapin','Chat']
  }
};

function generateNick() {
  const words = NICK_WORDS[currentLang] || NICK_WORDS.en;
  const adj = words.adj[Math.floor(Math.random() * words.adj.length)];
  const noun = words.noun[Math.floor(Math.random() * words.noun.length)];
  currentNick = adj + noun;
  return currentNick;
}

function updateNickDisplay() {
  document.getElementById('nick-display-start').textContent = currentNick;
}

// Validate nick against all language dictionaries
function isValidNick(nick) {
  for (const lang in NICK_WORDS) {
    const words = NICK_WORDS[lang];
    for (const adj of words.adj) {
      if (nick.startsWith(adj)) {
        const rest = nick.substring(adj.length);
        if (words.noun.includes(rest)) {
          return true;
        }
      }
    }
  }
  return false;
}

function applyLang(lang) {
  currentLang = lang;
  const L = LANG[lang];
  document.getElementById('title-1').textContent = L.title1;
  document.getElementById('title-2').textContent = L.title2;
  document.getElementById('t-subtitle').textContent = L.subtitle;
  document.getElementById('t-next').textContent = L.next;
  document.getElementById('t-lang').textContent = L.lang;
  document.getElementById('t-level').textContent = L.level;
  document.getElementById('t-move').textContent = L.move;
  document.getElementById('t-rotate').textContent = L.rotate;
  document.getElementById('t-accel').textContent = L.accel;
  document.getElementById('t-drop').textContent = L.drop;
  document.getElementById('t-pause-hint').textContent = L.pauseHint;
  document.getElementById('t-gameover').textContent = L.gameover;
  document.getElementById('t-total-label').textContent = L.totalLabel;
  document.getElementById('restart-btn').textContent = L.restart;
  document.getElementById('t-score').textContent = L.score;
  document.getElementById('t-penalty').textContent = L.penalty;
  document.getElementById('t-pieces').textContent = L.pieces;
  document.getElementById('t-total').textContent = L.total;
  document.getElementById('t-go-score').textContent = L.goScore;
  document.getElementById('t-go-penalty').textContent = L.goPenalty;
  document.getElementById('t-go-pieces').textContent = L.goPieces;
  document.getElementById('t-scoring').textContent = L.scoring;
  document.getElementById('t-s1').textContent = L.s1;
  document.getElementById('t-s2').textContent = L.s2;
  document.getElementById('t-s3').textContent = L.s3;
  document.getElementById('t-s4').textContent = L.s4;
  document.getElementById('t-s5').textContent = L.s5;
  document.getElementById('t-paused').textContent = L.paused;
  document.getElementById('t-lb-title').textContent = L.lbTitle;
  
  // Start screen
  document.getElementById('t-start-title').textContent = L.startTitle;
  document.getElementById('t-start-sub').textContent = L.startSub;
  document.getElementById('t-your-nick').textContent = L.yourNick;
  document.getElementById('t-choose-width').textContent = L.chooseWidth;
  document.getElementById('start-btn').textContent = L.play;
  document.getElementById('nick-input').placeholder = L.orEnter;
  
  document.querySelectorAll('.lang-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.lang === lang);
  });

  const isJa = lang === 'ja';
  document.getElementById('title-1').style.fontFamily = isJa ? "'Noto Sans JP','Orbitron',sans-serif" : "'Orbitron',sans-serif";
  document.getElementById('title-2').style.fontFamily = isJa ? "'Noto Sans JP','Orbitron',sans-serif" : "'Orbitron',sans-serif";
  document.getElementById('t-gameover').style.fontFamily = isJa ? "'Noto Sans JP','Orbitron',sans-serif" : "'Orbitron',sans-serif";
  document.getElementById('t-paused').style.fontFamily = isJa ? "'Noto Sans JP','Orbitron',sans-serif" : "'Orbitron',sans-serif";
  document.getElementById('t-start-title').style.fontFamily = isJa ? "'Noto Sans JP','Orbitron',sans-serif" : "'Orbitron',sans-serif";

  loadLeaderboard(COLS);
}

// ===== GAME ENGINE =====
const ROWS=20; let COLS=7; const CELL=28; const MAX_COLS=8;

const SHAPES={
  I:[[0,0],[1,0],[2,0],[3,0]], O:[[0,0],[1,0],[0,1],[1,1]],
  T:[[0,0],[1,0],[2,0],[1,1]], S:[[1,0],[2,0],[0,1],[1,1]],
  Z:[[0,0],[1,0],[1,1],[2,1]], L:[[0,0],[1,0],[2,0],[2,1]],
  J:[[0,0],[1,0],[2,0],[0,1]]
};
const COLORS={I:'#0092bb',O:'#cc8800',T:'#7733aa',S:'#1e7e3e',Z:'#c02030',L:'#cc5500',J:'#1e5eaa'};
const DARK={I:'#006080',O:'#885500',T:'#4e1a70',S:'#0e5528',Z:'#801018',L:'#883800',J:'#0e3870'};
const LIGHT={I:'#55ccdd',O:'#ddaa33',T:'#aa66cc',S:'#44aa66',Z:'#dd5566',L:'#ee8833',J:'#4488cc'};

let grid=[],currentPiece=null,nextPieceType=null;
let score=0,penalties=0,piecesPlaced=0,level=1;
let gameOver=false,paused=false,gameStarted=false;
let dropInterval=800,lastDrop=0,animFrameId=null;

const canvas=document.getElementById('game-canvas');
const ctx=canvas.getContext('2d');
const nextCanvas=document.getElementById('next-piece-canvas');
const nextCtx=nextCanvas.getContext('2d');

function initGrid(){grid=[];for(let r=0;r<ROWS;r++)grid.push(new Array(COLS).fill(null));}
function resizeCanvas(){canvas.width=MAX_COLS*CELL;canvas.height=ROWS*CELL;}
function getOffsetX(){return Math.floor((MAX_COLS-COLS)*CELL/2);}
function randomType(){const t=Object.keys(SHAPES);return t[Math.floor(Math.random()*t.length)];}
function createPiece(type){
  const cells=SHAPES[type].map(c=>[...c]);
  const maxX=Math.max(...cells.map(c=>c[0]));
  const off=Math.floor((COLS-maxX-1)/2);
  return{type,cells:cells.map(c=>[c[0]+off,c[1]])};
}
function rotatePiece(p){
  const cx=p.cells.reduce((s,c)=>s+c[0],0)/p.cells.length;
  const cy=p.cells.reduce((s,c)=>s+c[1],0)/p.cells.length;
  const rot=p.cells.map(([x,y])=>[Math.round(cx-(y-cy)),Math.round(cy+(x-cx))]);
  const minX=Math.min(...rot.map(c=>c[0])),maxX=Math.max(...rot.map(c=>c[0]));
  let sx=0;if(minX<0)sx=-minX;if(maxX>=COLS)sx=COLS-1-maxX;
  const shifted=rot.map(c=>[c[0]+sx,c[1]]);
  if(shifted.every(([x,y])=>x>=0&&x<COLS&&y>=0&&y<ROWS&&!grid[y][x]))p.cells=shifted;
}
function canMove(p,dx,dy){return p.cells.every(([x,y])=>{const nx=x+dx,ny=y+dy;return nx>=0&&nx<COLS&&ny>=0&&ny<ROWS&&!grid[ny][nx];});}
function movePiece(dx,dy){
  if(!currentPiece||gameOver||paused||!gameStarted)return false;
  if(canMove(currentPiece,dx,dy)){currentPiece.cells=currentPiece.cells.map(([x,y])=>[x+dx,y+dy]);return true;}
  return false;
}
function hardDrop(){
  if(!currentPiece||gameOver||paused||!gameStarted)return;
  while(canMove(currentPiece,0,1))currentPiece.cells=currentPiece.cells.map(([x,y])=>[x,y+1]);
  lockPiece();
}
function getGhost(){
  if(!currentPiece)return null;
  let dy=0;while(canMove(currentPiece,0,dy+1))dy++;
  return currentPiece.cells.map(([x,y])=>[x,y+dy]);
}
function rowInfo(r){if(!grid[r])return{filled:0,holes:COLS};let f=0;for(let c=0;c<COLS;c++)if(grid[r][c])f++;return{filled:f,holes:COLS-f};}
function isSealed(r){
  for(let c=0;c<COLS;c++){
    if(!grid[r][c]){let s=false;for(let a=0;a<r;a++){if(grid[a][c]){s=true;break;}}if(!s)return false;}
  }
  return true;
}

function lockPiece(){
  if(!currentPiece)return;
  for(const[x,y]of currentPiece.cells){if(y<0){endGame();return;}grid[y][x]=currentPiece.type;}
  piecesPlaced++;
  let again=true;
  while(again){again=false;for(let r=ROWS-1;r>=0;r--){if(rowInfo(r).holes===0){penalties+=50;showPopup(r,'‚àí50',true);showFlash(r,true);grid.splice(r,1);grid.unshift(new Array(COLS).fill(null));again=true;break;}}}
  let pts=0;
  for(let r=0;r<ROWS;r++){const{filled,holes}=rowInfo(r);if(filled===0||holes<1||holes>3)continue;if(!isSealed(r))continue;let rp=holes===1?5:holes===2?3:2;pts+=rp;if(rp>=3){showPopup(r,'+'+rp,false);showFlash(r,false);}}
  score+=pts;
  level=Math.floor(piecesPlaced/15)+1;
  dropInterval=Math.max(150,800-(level-1)*60);
  updateUI();
  if(grid[0].some(c=>c!==null)){endGame();return;}
  spawnPiece();
}

function spawnPiece(){
  currentPiece=createPiece(nextPieceType||randomType());
  nextPieceType=randomType();
  if(!currentPiece.cells.every(([x,y])=>y>=0&&y<ROWS&&x>=0&&x<COLS&&!grid[y][x])){endGame();return;}
  drawNext();
}

function draw(){
  const W=COLS*CELL,H=ROWS*CELL,OX=getOffsetX();
  ctx.clearRect(0,0,canvas.width,canvas.height);ctx.fillStyle='#e8e8ec';ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#f0f0f4';ctx.fillRect(OX,0,W,H);
  ctx.strokeStyle='#ccccd4';ctx.lineWidth=1;
  for(let r=0;r<=ROWS;r++){ctx.beginPath();ctx.moveTo(OX,r*CELL+.5);ctx.lineTo(OX+W,r*CELL+.5);ctx.stroke();}
  for(let c=0;c<=COLS;c++){ctx.beginPath();ctx.moveTo(OX+c*CELL+.5,0);ctx.lineTo(OX+c*CELL+.5,H);ctx.stroke();}
  if(!grid.length)return;
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++)if(grid[r]&&grid[r][c])drawBlock(ctx,c,r,grid[r][c],OX);
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
    if(!grid[r]||!grid[r][c]){let sealed=false;for(let a=0;a<r;a++){if(grid[a]&&grid[a][c]){sealed=true;break;}}
    if(sealed){ctx.fillStyle='rgba(26,138,74,.1)';ctx.fillRect(OX+c*CELL+1,r*CELL+1,CELL-2,CELL-2);ctx.fillStyle='rgba(26,138,74,.45)';const mx=OX+c*CELL+CELL/2,my=r*CELL+CELL/2;ctx.beginPath();ctx.moveTo(mx,my-4);ctx.lineTo(mx+4,my);ctx.lineTo(mx,my+4);ctx.lineTo(mx-4,my);ctx.closePath();ctx.fill();}}
  }
  for(let r=0;r<ROWS;r++){const{filled,holes}=rowInfo(r);if(filled===0)continue;
    if(holes===0){ctx.fillStyle='rgba(196,24,48,.12)';ctx.fillRect(OX,r*CELL,W,CELL);}
    else if(holes>=1&&holes<=3&&isSealed(r)){ctx.fillStyle=holes===1?'rgba(26,138,74,.7)':holes===2?'rgba(46,139,87,.5)':'rgba(90,154,58,.4)';ctx.fillRect(OX+W-4,r*CELL+6,3,CELL-12);}
  }
  if(currentPiece&&!gameOver&&!paused&&gameStarted){const gh=getGhost();if(gh)for(const[x,y]of gh){ctx.strokeStyle='rgba(0,0,0,.18)';ctx.lineWidth=1.5;ctx.setLineDash([3,3]);ctx.strokeRect(OX+x*CELL+3,y*CELL+3,CELL-6,CELL-6);ctx.setLineDash([]);}}
  if(currentPiece&&!gameOver&&!paused&&gameStarted)for(const[x,y]of currentPiece.cells)if(y>=0)drawBlock(ctx,x,y,currentPiece.type,OX);
}

function drawBlock(c,x,y,type,ox=0){
  const px=ox+x*CELL,py=y*CELL;
  c.fillStyle=COLORS[type];c.fillRect(px+2,py+2,CELL-4,CELL-4);
  c.strokeStyle=DARK[type];c.lineWidth=1.5;c.strokeRect(px+2.5,py+2.5,CELL-5,CELL-5);
  c.fillStyle=LIGHT[type];c.fillRect(px+3,py+3,CELL-6,3);c.fillRect(px+3,py+3,3,CELL-6);
  c.fillStyle=DARK[type];c.fillRect(px+3,py+CELL-5,CELL-6,2);c.fillRect(px+CELL-5,py+3,2,CELL-6);
}

function drawNext(){
  nextCtx.clearRect(0,0,100,70);nextCtx.fillStyle='#f0f0f4';nextCtx.fillRect(0,0,100,70);
  if(!nextPieceType)return;
  const cells=SHAPES[nextPieceType];
  const minX=Math.min(...cells.map(c=>c[0])),maxX=Math.max(...cells.map(c=>c[0]));
  const minY=Math.min(...cells.map(c=>c[1])),maxY=Math.max(...cells.map(c=>c[1]));
  const bs=18,ox=(100-(maxX-minX+1)*bs)/2,oy=(70-(maxY-minY+1)*bs)/2;
  for(const[cx,cy]of cells){
    const px=ox+(cx-minX)*bs,py=oy+(cy-minY)*bs;
    nextCtx.fillStyle=COLORS[nextPieceType];nextCtx.fillRect(px+2,py+2,bs-4,bs-4);
    nextCtx.strokeStyle=DARK[nextPieceType];nextCtx.lineWidth=1;nextCtx.strokeRect(px+2.5,py+2.5,bs-5,bs-5);
    nextCtx.fillStyle=LIGHT[nextPieceType];nextCtx.fillRect(px+3,py+3,bs-6,2);
  }
}

function showPopup(row,text,isPenalty){
  const p=document.createElement('div');p.className='row-popup '+(isPenalty?'penalty':'good');p.textContent=text;
  const cr=canvas.getBoundingClientRect(),wr=canvas.parentElement.getBoundingClientRect();
  p.style.left=(cr.left-wr.left+canvas.width+8)+'px';p.style.top=(cr.top-wr.top+row*CELL)+'px';
  canvas.parentElement.appendChild(p);setTimeout(()=>p.remove(),1200);
}
function showFlash(row,isPenalty){
  const f=document.createElement('div');f.className='row-flash '+(isPenalty?'penalty-flash':'good-flash');
  const cr=canvas.getBoundingClientRect(),wr=canvas.parentElement.getBoundingClientRect();
  const OX=getOffsetX();
  f.style.left=(cr.left-wr.left+OX)+'px';f.style.top=(cr.top-wr.top+row*CELL)+'px';
  f.style.width=(COLS*CELL)+'px';f.style.height=CELL+'px';
  canvas.parentElement.appendChild(f);setTimeout(()=>f.remove(),800);
}

function updateUI(){
  document.getElementById('score-display').textContent=score;
  document.getElementById('penalty-display').textContent=penalties;
  document.getElementById('pieces-display').textContent=piecesPlaced;
  document.getElementById('total-display').textContent=Math.max(0,score-penalties);
  document.getElementById('level-display').textContent=level;
}

function shareResultDyrokol(){
  const total=document.getElementById('go-total').textContent;
  const w=COLS||7;
  const t='üï≥ HolePuncher w'+w+'\nüèÜ Score: '+total+'\nhttps://constrik.itch.io/holepuncher';
  try{const ta=document.createElement('textarea');ta.value=t;ta.style.position='fixed';ta.style.left='-9999px';document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);
  const b=event.target;b.textContent='‚úì Copied!';setTimeout(()=>b.textContent='üì§ Share',2000);}catch(e){prompt('Copy:',t);}
}

async function endGame(){
  gameOver=true;
  gameStarted=false;
  const total=Math.max(0,score-penalties);
  
  document.getElementById('go-nick').textContent = currentNick;
  document.getElementById('go-total').textContent=total;
  document.getElementById('go-score').textContent=score;
  document.getElementById('go-penalty').textContent=penalties;
  document.getElementById('go-pieces').textContent=piecesPlaced;
  
  const L = LANG[currentLang];
  
  // Submit and check for record
  const localResult = saveLocalScore(currentNick, total, COLS);
  let isNewRecord = localResult.isNewRecord;
  
  if (firebaseOk) {
    const fbResult = await submitScore(currentNick, total, COLS);
    if (fbResult.success) {
      isNewRecord = fbResult.isNewRecord;
    }
  }
  
  const recordEl = document.getElementById('go-record');
  if (isNewRecord) {
    recordEl.textContent = L.newRecord || 'üéâ NEW RECORD!';
    recordEl.className = 'go-record new-record';
  } else {
    recordEl.textContent = L.noRecord || 'Your best stays';
    recordEl.className = 'go-record';
  }
  
  document.getElementById('game-over').classList.add('show');
  loadLeaderboard(COLS);
}

function showStartScreen() {
  document.getElementById('start-screen').classList.remove('hidden');
  document.getElementById('game-over').classList.remove('show');
  
  // Load saved nick or generate new
  const savedNick = localStorage.getItem('dyrokol_nick');
  if (savedNick && isValidNick(savedNick)) {
    currentNick = savedNick;
  } else {
    generateNick();
  }
  updateNickDisplay();
  
  resizeCanvas();
  draw();
}

function startGame(){
  // Save nick
  localStorage.setItem('dyrokol_nick', currentNick);
  
  document.getElementById('start-screen').classList.add('hidden');
  
  initGrid();score=0;penalties=0;piecesPlaced=0;level=1;
  dropInterval=800;gameOver=false;paused=false;gameStarted=true;
  currentPiece=null;nextPieceType=randomType();
  document.getElementById('game-over').classList.remove('show');
  document.getElementById('pause-overlay').classList.remove('show');
  resizeCanvas();updateUI();spawnPiece();
  lastDrop=performance.now();
  if(animFrameId)cancelAnimationFrame(animFrameId);
  gameLoop();
}

function gameLoop(time=0){
  animFrameId=requestAnimationFrame(gameLoop);
  if(gameOver||paused||!gameStarted){draw();return;}
  if(time-lastDrop>dropInterval){if(!movePiece(0,1))lockPiece();lastDrop=time;}
  draw();
}

// ===== INPUT =====
document.addEventListener('keydown',(e)=>{
  if(!gameStarted && !document.getElementById('start-screen').classList.contains('hidden')){
    if(e.code==='Space'||e.code==='Enter'){e.preventDefault();startGame();}
    return;
  }
  if(gameOver){if(e.code==='Space'||e.code==='Enter'){e.preventDefault();showStartScreen();}return;}
  switch(e.code){
    case'ArrowLeft':e.preventDefault();movePiece(-1,0);break;
    case'ArrowRight':e.preventDefault();movePiece(1,0);break;
    case'ArrowDown':e.preventDefault();movePiece(0,1);break;
    case'ArrowUp':e.preventDefault();if(currentPiece&&!paused)rotatePiece(currentPiece);break;
    case'Space':e.preventDefault();hardDrop();break;
    case'KeyP':paused=!paused;document.getElementById('pause-overlay').classList.toggle('show',paused);break;
  }
});

// Width selector on start screen
document.querySelectorAll('.width-btn-start').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const w=parseInt(btn.dataset.w);
    document.querySelectorAll('.width-btn-start').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    COLS=w;
    resizeCanvas();
    draw();
    loadLeaderboard(w);
  });
});

document.querySelectorAll('.lang-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{applyLang(btn.dataset.lang);});
});

// Nick reroll
document.getElementById('nick-reroll-start').addEventListener('click', ()=>{
  generateNick();
  updateNickDisplay();
  document.getElementById('nick-status').textContent = '';
});

// Nick input check
document.getElementById('nick-check-btn').addEventListener('click', ()=>{
  const input = document.getElementById('nick-input').value.trim();
  const L = LANG[currentLang];
  if (input && isValidNick(input)) {
    currentNick = input;
    updateNickDisplay();
    document.getElementById('nick-status').textContent = L.nickOk || '‚úì';
    document.getElementById('nick-status').style.color = 'var(--good)';
    document.getElementById('nick-input').value = '';
  } else {
    document.getElementById('nick-status').textContent = L.nickInvalid || 'Invalid';
    document.getElementById('nick-status').style.color = 'var(--accent)';
  }
});

document.getElementById('nick-input').addEventListener('keydown', (e)=>{
  if (e.code === 'Enter') {
    document.getElementById('nick-check-btn').click();
  }
});

// Start button
document.getElementById('start-btn').addEventListener('click', startGame);

// Restart goes to start screen
document.getElementById('restart-btn').addEventListener('click', showStartScreen);

// Mobile controls
document.getElementById('btn-left')?.addEventListener('touchstart',(e)=>{e.preventDefault();movePiece(-1,0);});
document.getElementById('btn-right')?.addEventListener('touchstart',(e)=>{e.preventDefault();movePiece(1,0);});
document.getElementById('btn-down')?.addEventListener('touchstart',(e)=>{e.preventDefault();movePiece(0,1);});
document.getElementById('btn-rotate')?.addEventListener('touchstart',(e)=>{e.preventDefault();if(currentPiece&&!paused)rotatePiece(currentPiece);});
document.getElementById('btn-drop')?.addEventListener('touchstart',(e)=>{e.preventDefault();hardDrop();});

// ===== INIT =====
applyLang('ru');
showStartScreen();
</script>
<div style="text-align:center;font-size:.55rem;color:rgba(255,255,255,0.3);padding:8px;">HolePuncher v2.0 ¬∑ <a href="https://constrik.itch.io" style="color:rgba(255,255,255,0.3);">constrik</a></div>
</body>
</html>
